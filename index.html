<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SPORTROLIC TECH BIBVOICE</title>
<style>
body { font-family: sans-serif; padding: 20px; }
input[type="text"], input[type="tel"] { font-size: 1.2em; padding: 5px; margin-bottom: 5px; width: 250px; }
button { font-size: 1em; margin: 5px; padding: 5px 10px; }
table { border-collapse: collapse; margin-top: 15px; width: 100%; max-height: 300px; display: block; overflow-y: auto; }
table, th, td { border: 1px solid #ccc; }
th, td { padding: 8px; text-align: left; }
.highlight { background-color: #ffff99; }
#status { font-weight: bold; margin-bottom: 10px; }
.listening { color: green; }
.stopped { color: red; }
</style>
</head>
<body>

<h2>SPORTROLIC TECH BIBVOICE</h2>

Event Name: <input id="eventInput" type="text" placeholder="Enter event name" /><br>
Device Name: <input id="deviceInput" type="text" placeholder="Enter device name" /><br>
WhatsApp Number (with country code): <input id="waNumberInput" type="tel" placeholder="e.g., 919876543210" /><br><br>

<div id="status" class="stopped">‚èπ Not Listening</div>

<button onclick="startListening()">üé§ Start Listening</button>
<button onclick="stopListening()">‚èπ Stop Listening</button>
<button onclick="downloadCSV()">‚¨áÔ∏è Export CSV</button>
<button onclick="sendWhatsAppCSV()">üì§ Send CSV to WhatsApp</button>
<button onclick="uploadToServer()">‚¨ÜÔ∏è Upload to Server</button>
<button onclick="deleteData()">üóëÔ∏è Delete Data</button><br><br>

Type Number: <input id="numberInput" type="text" placeholder="Enter number" />

<table id="dataTable">
  <tr><th>Event</th><th>Device</th><th>Number</th><th>Time</th></tr>
</table>

<script>
let recognition;
let listening = false;
let results = [["Event","Device","Number","Time"]];
const SERVER_URL = "https://script.google.com/macros/s/AKfycbzkXloxcsiXOf4JAybPX5ZfkNmxyklBvxyTJodY1GD7LOcTqr18zLW--4JoiYVCHBX8/exec";

// 24-hour timestamp
function getCurrentTimestamp() {
  const now = new Date();
  const h = String(now.getHours()).padStart(2,'0');
  const m = String(now.getMinutes()).padStart(2,'0');
  const s = String(now.getSeconds()).padStart(2,'0');
  return `${h}:${m}:${s}`;
}

// Add a row to table (latest on top) + save to localStorage
function addRow(event, device, number) {
  const time = getCurrentTimestamp();
  results.push([event, device, number, time]);

  const table = document.getElementById("dataTable");
  const row = table.insertRow(1); // insert at top
  row.insertCell(0).textContent = event;
  row.insertCell(1).textContent = device;
  row.insertCell(2).textContent = number;
  row.insertCell(3).textContent = time;

  for(let i=1;i<table.rows.length;i++) table.rows[i].classList.remove("highlight");
  row.classList.add("highlight");

  saveData();
}

// Save results into localStorage
function saveData(){
  localStorage.setItem("results", JSON.stringify(results));
}

// Load saved results on page load
window.onload = function(){
  const saved = localStorage.getItem("results");
  if(saved){
    results = JSON.parse(saved);
    for(let i=1;i<results.length;i++){
      const [event, device, number, time] = results[i];
      const table = document.getElementById("dataTable");
      const row = table.insertRow(-1);
      row.insertCell(0).textContent = event;
      row.insertCell(1).textContent = device;
      row.insertCell(2).textContent = number;
      row.insertCell(3).textContent = time;
    }
  }
}

// Delete all stored data
function deleteData(){
  if(confirm("Are you sure you want to delete all data?")){
    results = [["Event","Device","Number","Time"]];
    localStorage.removeItem("results");
    const table = document.getElementById("dataTable");
    table.innerHTML = "<tr><th>Event</th><th>Device</th><th>Number</th><th>Time</th></tr>";
  }
}

// Convert spoken words to digits
function spokenToDigits(spoken) {
  spoken = spoken.toLowerCase();
  spoken = spoken.replace(/triple zero/g,'000').replace(/double zero/g,'00');
  spoken = spoken.replace(/\D/g,''); // remove non-digit characters
  return spoken;
}

// Start continuous speech recognition
function startListening() {
  const event = document.getElementById("eventInput").value.trim();
  const device = document.getElementById("deviceInput").value.trim();
  if(!event) return alert("Enter event name first");
  if(!device) return alert("Enter device name first");

  if(!('webkitSpeechRecognition' in window)){
    alert("Speech recognition not supported. Use Chrome.");
    return;
  }

  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = true;
  recognition.interimResults = false;

  recognition.onresult = function(eventObj){
    for(let i=eventObj.resultIndex;i<eventObj.results.length;i++){
      if(eventObj.results[i].isFinal){
        let spoken = eventObj.results[i][0].transcript.trim();
        let digits = spokenToDigits(spoken);
        if(digits.length>0) addRow(event,device,digits);
      }
    }
  }

  recognition.onerror = function(e){ console.error("Speech recognition error:", e); }

  recognition.onend = function(){ if(listening) recognition.start(); }

  recognition.start();
  listening = true;
  const statusDiv = document.getElementById("status");
  statusDiv.textContent = "üé§ Listening...";
  statusDiv.classList.remove("stopped");
  statusDiv.classList.add("listening");
}

// Stop listening
function stopListening() {
  if(recognition && listening){
    recognition.stop();
    listening=false;
    const statusDiv = document.getElementById("status");
    statusDiv.textContent = "‚èπ Not Listening";
    statusDiv.classList.remove("listening");
    statusDiv.classList.add("stopped");
  }
}

// Auto-save typed numbers
const numberInput = document.getElementById("numberInput");
numberInput.addEventListener("keypress",function(e){
  if(e.key==="Enter"){
    const event = document.getElementById("eventInput").value.trim();
    const device = document.getElementById("deviceInput").value.trim();
    const value = numberInput.value.trim();
    if(!event) return alert("Enter event name first");
    if(!device) return alert("Enter device name first");
    if(/^\d+$/.test(value)){
      addRow(event,device,value);
      numberInput.value="";
    } else { alert("Please enter digits only."); }
  }
});

// Export CSV with event+device name + date
function downloadCSV(){
  const event = document.getElementById("eventInput").value.trim() || "Event";
  const device = document.getElementById("deviceInput").value.trim() || "Device";
  const now = new Date();
  const dateStr = now.toISOString().slice(0,10);
  const filename = `${event.replace(/\s+/g,'_')}_${device.replace(/\s+/g,'_')}_${dateStr}.csv`;
  let csvContent = results.map(r=>r.join(",")).join("\n");
  const blob = new Blob([csvContent],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=filename; a.click();
  URL.revokeObjectURL(url);
}

// Send CSV to WhatsApp
function sendWhatsAppCSV(){
  const waNumber = document.getElementById("waNumberInput").value.trim();
  if(!waNumber) return alert("Enter WhatsApp number with country code");
  if(results.length<=1) return alert("No numbers logged yet");

  let csvText = results.map(r=>r.join(",")).join("\n");
  csvText = encodeURIComponent(csvText);
  const url = `https://wa.me/${waNumber}?text=${csvText}`;
  window.open(url,'_blank');
}

// Upload to Google Sheet server
function uploadToServer(){
  for(let i=1;i<results.length;i++){
    const [event,device,number,time] = results[i];
    fetch(SERVER_URL,{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({event,device,number,time})
    })
    .then(res=>console.log("Uploaded:", event, device, number, time))
    .catch(err=>console.error("Upload failed:", err));
  }
  alert("Upload attempt completed. Check your Google Sheet.");
}
</script>

</body>
</html>
