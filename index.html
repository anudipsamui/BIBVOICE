<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SPORTROLIC TECH BIBVOICE</title>
<style>
body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  background: #f6f8fa;
  margin: 0;
  padding: 20px;
}
header {
  background: #2d3748;
  color: #fff;
  padding: 12px 16px;
  border-radius: 8px;
  text-align: center;
  font-weight: 700;
  font-size: 18px;
}
.card {
  max-width: 900px;
  margin: 18px auto;
  background: #fff;
  padding: 16px;
  border-radius: 8px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.06);
}
label {
  display: block;
  font-weight: 600;
  margin-top: 8px;
}
input[type="text"] {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  border-radius: 6px;
  border: 1px solid #d0d7de;
  font-size: 1rem;
}
.row { display: flex; gap: 12px; flex-wrap: wrap; }
.col { flex: 1 1 200px; }
.buttons { margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; }
button {
  background: #2d3748;
  color: #fff;
  border: none;
  padding: 10px 14px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 700;
}
button.secondary { background: #6b7280; }
#status { margin-top: 10px; text-align: center; font-weight: 700; }
#status.listening { color: green; }
#status.stopped { color: red; }
.table-wrap {
  margin-top: 14px;
  max-height: 420px;
  overflow: auto;
  border: 1px solid #e6e9ef;
  border-radius: 6px;
  background: #fff;
}
table {
  width: 100%;
  border-collapse: collapse;
  min-width: 400px;
}
th, td {
  padding: 8px 10px;
  border-bottom: 1px solid #f0f0f0;
  text-align: left;
  font-family: monospace;
}
thead th {
  position: sticky;
  top: 0;
  background: #111827;
  color: #fff;
  z-index: 2;
}
tr.latest { background: #ffff99; font-weight: 700; }
@media (max-width: 640px) {
  .row { flex-direction: column; }
  input[type="text"] { font-size: 0.95rem; }
  button { flex: 1; }
}
</style>
</head>
<body>
<header>SPORTROLIC TECH BIBVOICE</header>

<div class="card">
  <label for="bibInput">BIB Number (type or speak)</label>
  <input id="bibInput" type="text" inputmode="numeric" placeholder="Enter BIB number" />

  <div class="row">
    <div class="col">
      <label for="volunteerInput">Volunteer Name</label>
      <input id="volunteerInput" type="text" placeholder="Enter Volunteer Name" />
    </div>
    <div class="col">
      <label for="locationInput">Timing Location Name</label>
      <input id="locationInput" type="text" placeholder="Enter Timing Location Name" />
    </div>
  </div>

  <div class="buttons">
    <button id="startBtn">üé§ Start Listening</button>
    <button id="stopBtn" class="secondary">‚èπ Stop Listening</button>
    <button id="addBtn" class="secondary">‚ûï Add Entry</button>
    <button id="downloadBtn">‚¨áÔ∏è Download CSV</button>
    <button id="deleteBtn" class="secondary">üóëÔ∏è Delete Data</button>
  </div>

  <div id="status" class="stopped">‚èπ Not Listening</div>

  <div class="table-wrap" id="tableWrap">
    <table id="dataTable">
      <thead>
        <tr><th>BIB Number</th><th>Time</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const bibInput = document.getElementById("bibInput");
const volunteerInput = document.getElementById("volunteerInput");
const locationInput = document.getElementById("locationInput");
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const addBtn = document.getElementById("addBtn");
const downloadBtn = document.getElementById("downloadBtn");
const deleteBtn = document.getElementById("deleteBtn");
const statusDiv = document.getElementById("status");
const dataTableBody = document.querySelector("#dataTable tbody");
const tableWrap = document.getElementById("tableWrap");

let entries = JSON.parse(localStorage.getItem("raceData") || "[]");
let recognition = null;
let listening = false;

function nowParts() {
  const n = new Date();
  const date = n.toLocaleDateString("en-GB");
  const time = n.toLocaleTimeString("en-GB", { hour12: false });
  return { date, time };
}

function save() {
  localStorage.setItem("raceData", JSON.stringify(entries));
}

function render() {
  dataTableBody.innerHTML = "";
  for (let i = entries.length - 1; i >= 0; i--) {
    const e = entries[i];
    const tr = document.createElement("tr");
    if (i === entries.length - 1) tr.classList.add("latest");
    tr.innerHTML = `<td>${e.bib}</td><td>${e.time}</td>`;
    dataTableBody.appendChild(tr);
  }
  tableWrap.scrollTop = 0;
}

function addEntry(bibValue) {
  const bib = String(bibValue || "").trim().replace(/\D/g, "");
  if (!bib) {
    alert("Enter valid BIB number");
    return;
  }
  const volunteer = volunteerInput.value.trim() || "Unknown_Volunteer";
  const location = locationInput.value.trim() || "Unknown_Location";
  const { date, time } = nowParts();
  entries.push({ bib, volunteer, location, date, time });
  save();
  render();
}

addBtn.onclick = () => addEntry(bibInput.value);
bibInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    addEntry(bibInput.value);
    bibInput.value = "";
  }
});

downloadBtn.onclick = () => {
  if (!entries.length) return alert("No data");
  const volunteer = volunteerInput.value.trim() || "Volunteer";
  const location = locationInput.value.trim() || "Location";
  const filename = `${location.replace(/\s+/g, "_")}_${new Date().toISOString().slice(0,10)}.csv`;
  let csv = "Volunteer Name,Timing Location,Date,Time,BIB Number\n";
  for (let i = entries.length - 1; i >= 0; i--) {
    const e = entries[i];
    csv += `${e.volunteer},${e.location},${e.date},${e.time},${e.bib}\n`;
  }
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
};

deleteBtn.onclick = () => {
  if (confirm("Delete all data?")) {
    entries = [];
    save();
    render();
  }
};

const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
function startListening() {
  if (!SpeechRec) return alert("Speech recognition not supported in this browser");
  if (listening) return;
  if (!volunteerInput.value.trim()) return alert("Enter Volunteer Name");
  if (!locationInput.value.trim()) return alert("Enter Timing Location Name");

  recognition = new SpeechRec();
  recognition.lang = "en-US";
  recognition.continuous = true;
  recognition.interimResults = false;

  recognition.onresult = (evt) => {
    for (let i = evt.resultIndex; i < evt.results.length; i++) {
      if (evt.results[i].isFinal) {
        let t = evt.results[i][0].transcript.trim().toLowerCase();
        t = t.replace(/triple zero/g, "000").replace(/double zero/g, "00").replace(/\D/g, "");
        if (t) {
          bibInput.value = t;
          addEntry(t);
          bibInput.value = "";
        }
      }
    }
  };
  recognition.onend = () => { if (listening) recognition.start(); };
  recognition.onerror = (e) => console.error(e);
  recognition.start();
  listening = true;
  statusDiv.textContent = "üé§ Listening...";
  statusDiv.className = "listening";
}

function stopListening() {
  if (recognition) recognition.stop();
  listening = false;
  statusDiv.textContent = "‚èπ Not Listening";
  statusDiv.className = "stopped";
}

startBtn.onclick = startListening;
stopBtn.onclick = stopListening;
render();
</script>
</body>
</html>
