<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SPORTROLIC TECH BIBVOICE</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #f8f8f8;
  }
  h1 {
    text-align: center;
  }
  .controls {
    text-align: center;
    margin: 20px 0;
  }
  input {
    padding: 6px;
    font-size: 16px;
    width: 200px;
    margin: 5px;
  }
  button {
    padding: 6px 12px;
    margin-left: 5px;
    font-size: 16px;
    cursor: pointer;
  }
  #status {
    font-weight: bold;
    text-align: center;
    margin-bottom: 10px;
  }
  #status.listening { color: green; }
  #status.stopped { color: red; }
  #tableWrap {
    max-height: 300px;
    overflow-y: auto;
    margin-top: 20px;
    border: 1px solid #ccc;
    background: #fff;
  }
  table {
    width: 100%;
    border-collapse: collapse;
  }
  th, td {
    padding: 8px;
    border: 1px solid #ccc;
    text-align: center;
  }
  .highlight { background-color: #ffff99; }
</style>
</head>
<body>

<h1>SPORTROLIC TECH BIBVOICE</h1>

<div id="status" class="stopped">‚èπ Not Listening</div>

<div class="controls">
  Device Name: <input id="deviceInput" placeholder="Enter device name">
  <input id="manualInput" placeholder="Type BIB number & press Enter">
  <br>
  <button onclick="startListening()">üé§ Start Listening</button>
  <button onclick="stopListening()">‚èπ Stop Listening</button>
  <button onclick="downloadCSV()">‚¨á Download CSV</button>
  <button onclick="sendWhatsApp()">üì≤ Send WhatsApp</button>
</div>

<div id="tableWrap">
  <table id="dataTable">
    <thead>
      <tr><th>Device</th><th>BIB Number</th><th>Timestamp</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
let recognition;
let listening = false;
let results = [];

// Load saved numbers from localStorage
if(localStorage.getItem("bibvoiceResults")) {
  results = JSON.parse(localStorage.getItem("bibvoiceResults"));
  results.reverse().forEach(r => addRowToTable(r[0], r[1], r[2], false));
}

// 24-hour timestamp
function getCurrentTimestamp() {
  const now = new Date();
  return now.toLocaleTimeString();
}

// Convert spoken words to digits
function spokenToDigits(spoken) {
  spoken = spoken.toLowerCase();
  spoken = spoken.replace(/triple zero/g, '000').replace(/double zero/g, '00');
  const map = {
    "zero":"0","oh":"0","o":"0",
    "one":"1","two":"2","three":"3",
    "four":"4","five":"5","six":"6",
    "seven":"7","eight":"8","nine":"9"
  };
  return spoken.split(/\s+/).map(w => map[w] ?? "").join("");
}

// Add row to table and handle highlight
function addRow(device, bibNumber) {
  const time = getCurrentTimestamp();
  results.push([device, bibNumber, time]);
  localStorage.setItem("bibvoiceResults", JSON.stringify(results));

  addRowToTable(device, bibNumber, time, true);
}

// Internal helper to insert a row in DOM
function addRowToTable(device, bibNumber, time, highlight=true) {
  const table = document.getElementById("dataTable");

  // Remove previous highlight
  for (let i = 1; i < table.rows.length; i++) {
    table.rows[i].classList.remove("highlight");
  }

  const row = table.insertRow(1);
  row.insertCell(0).textContent = device;
  row.insertCell(1).textContent = bibNumber;
  row.insertCell(2).textContent = time;

  if(highlight) row.classList.add("highlight");
}

// Manual input
document.getElementById("manualInput").addEventListener("keydown", e => {
  if (e.key === "Enter" && e.target.value.trim() !== "") {
    const device = document.getElementById("deviceInput").value.trim() || "Manual";
    addRow(device, e.target.value.trim());
    e.target.value = "";
  }
});

// Start listening
function startListening() {
  const device = document.getElementById("deviceInput").value.trim() || "Speech";
  if (!('webkitSpeechRecognition' in window)) {
    alert("Speech recognition not supported in this browser");
    return;
  }

  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = true;
  recognition.interimResults = false;

  recognition.onresult = function(event) {
    for (let i = event.resultIndex; i < event.results.length; i++) {
      if (event.results[i].isFinal) {
        const spoken = event.results[i][0].transcript.trim();
        const digits = spokenToDigits(spoken);
        if (digits.length > 0) addRow(device, digits);
      }
    }
  };

  recognition.onerror = function(e) {
    console.error("Speech recognition error:", e);
  };

  recognition.onend = function() {
    if(listening) recognition.start(); // auto-restart
  };

  recognition.start();
  listening = true;

  const statusDiv = document.getElementById("status");
  statusDiv.textContent = "üé§ Listening...";
  statusDiv.classList.remove("stopped");
  statusDiv.classList.add("listening");
}

// Stop listening
function stopListening() {
  if (recognition && listening) {
    recognition.stop();
    listening = false;

    const statusDiv = document.getElementById("status");
    statusDiv.textContent = "‚èπ Not Listening";
    statusDiv.classList.remove("listening");
    statusDiv.classList.add("stopped");
  }
}

// Download CSV with device name + date
function downloadCSV() {
  if (results.length === 0) return alert("No BIB numbers to export.");
  const device = document.getElementById("deviceInput").value.trim() || "Device";
  const now = new Date();
  const dateStr = now.toISOString().slice(0,10); // YYYY-MM-DD
  const filename = `${device.replace(/\s+/g,'_')}_${dateStr}.csv`;

  let csv = "Device,BIB Number,Timestamp\n";
  results.forEach(r => { csv += r.join(",") + "\n"; });
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
}

// Send CSV to WhatsApp
function sendWhatsApp() {
  if (results.length === 0) return alert("No BIB numbers to send.");
  let text = "Device | BIB Number | Timestamp\n";
  results.forEach(r => { text += r.join(" | ") + "\n"; });
  const encoded = encodeURIComponent(text);
  window.open("https://wa.me/?text=" + encoded, "_blank");
}
</script>

</body>
</html>
