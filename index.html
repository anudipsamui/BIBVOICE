<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SPORTROLIC TECH BIBVOICE</title>
<style>
body { font-family: sans-serif; padding: 10px; }
input[type="text"] { font-size: 1.1em; padding: 6px; margin: 3px; width: 200px; }
button { font-size: 1em; margin: 4px; padding: 5px 10px; }
table { border-collapse: collapse; margin-top: 10px; width: 100%; display: block; max-height: 300px; overflow-y: auto; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
.highlight { background-color: #ffff99; }
#status { font-weight: bold; margin: 10px 0; }
.listening { color: green; }
.stopped { color: red; }
@media (max-width: 600px){
  input[type="text"] { width: 100%; }
  button { width: 48%; margin: 4px 1%; }
}
</style>
</head>
<body>

<h2>SPORTROLIC TECH BIBVOICE</h2>

<div style="display:flex; flex-wrap:wrap; gap:5px;">
  <div>
    Volunteer Name:<br>
    <input id="volunteerInput" type="text" placeholder="Enter volunteer name" />
  </div>
  <div>
    Timing Location Name:<br>
    <input id="deviceInput" type="text" placeholder="Enter timing location" />
  </div>
</div><br>

<div id="status" class="stopped">‚èπ Not Listening</div>

<button onclick="startListening()">üé§ Start Listening</button>
<button onclick="stopListening()">‚èπ Stop Listening</button>
<button onclick="downloadCSV()">‚¨áÔ∏è Export CSV</button>
<button onclick="deleteData()">üóë Delete Data</button><br><br>

Type Number: <input id="numberInput" type="text" placeholder="Enter BIB number" />

<table id="dataTable">
  <tr><th>BIB Number</th><th>Time</th></tr>
</table>

<script>
let recognition;
let listening = false;
let results = [["Volunteer","Location","BIB","Date","Time"]];

// Timestamp functions
function getCurrentTimestamp() {
  const now = new Date();
  const h = String(now.getHours()).padStart(2,'0');
  const m = String(now.getMinutes()).padStart(2,'0');
  const s = String(now.getSeconds()).padStart(2,'0');
  return `${h}:${m}:${s}`;
}
function getCurrentDate() {
  const now = new Date();
  return now.toISOString().slice(0,10);
}

// Add new entry (shows only BIB & Time)
function addRow(volunteer, device, number) {
  const time = getCurrentTimestamp();
  const date = getCurrentDate();
  results.push([volunteer, device, number, date, time]);

  const table = document.getElementById("dataTable");
  const row = table.insertRow(1);
  row.insertCell(0).textContent = number;
  row.insertCell(1).textContent = time;

  for(let i=1;i<table.rows.length;i++) table.rows[i].classList.remove("highlight");
  row.classList.add("highlight");
  table.scrollTop = 0;

  localStorage.setItem("bibvoiceData", JSON.stringify(results));
}

// Convert spoken to digits
function spokenToDigits(spoken){
  spoken = spoken.toLowerCase().replace(/triple zero/g,'000').replace(/double zero/g,'00');
  return spoken.replace(/\D/g,'');
}

// Start listening
function startListening(){
  const volunteer = document.getElementById("volunteerInput").value.trim();
  const device = document.getElementById("deviceInput").value.trim();
  if(!volunteer || !device) return alert("Enter volunteer and timing location first");

  if(!('webkitSpeechRecognition' in window)){
    alert("Speech recognition not supported. Use Chrome.");
    return;
  }

  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = true;
  recognition.interimResults = false;

  recognition.onresult = function(event){
    for(let i=event.resultIndex;i<event.results.length;i++){
      if(event.results[i].isFinal){
        const spoken = event.results[i][0].transcript.trim();
        const digits = spokenToDigits(spoken);
        if(digits.length>0) addRow(volunteer, device, digits);
      }
    }
  }

  recognition.onerror = e => console.error("Speech recognition error:", e);
  recognition.onend = ()=>{ if(listening) recognition.start(); };

  recognition.start();
  listening = true;
  const statusDiv = document.getElementById("status");
  statusDiv.textContent = "üé§ Listening...";
  statusDiv.classList.replace("stopped","listening");
}

// Stop listening
function stopListening(){
  if(recognition && listening){
    recognition.stop();
    listening = false;
    const statusDiv = document.getElementById("status");
    statusDiv.textContent = "‚èπ Not Listening";
    statusDiv.classList.replace("listening","stopped");
  }
}

// Manual entry
const numberInput = document.getElementById("numberInput");
numberInput.addEventListener("keypress",function(e){
  if(e.key==="Enter"){
    const volunteer = document.getElementById("volunteerInput").value.trim();
    const device = document.getElementById("deviceInput").value.trim();
    const value = numberInput.value.trim();
    if(!volunteer || !device) return alert("Enter volunteer and timing location first");
    if(/^\d+$/.test(value)){
      addRow(volunteer, device, value);
      numberInput.value="";
    } else { alert("Please enter digits only."); }
  }
});

// Export CSV
function downloadCSV(){
  const device = document.getElementById("deviceInput").value.trim() || "Device";
  const now = new Date();
  const dateStr = now.toISOString().slice(0,10);
  const filename = `${device.replace(/\s+/g,'_')}_${dateStr}.csv`;
  const csvContent = results.map(r=>r.join(",")).join("\n");
  const blob = new Blob([csvContent],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

// Delete stored data
function deleteData(){
  if(confirm("Are you sure you want to delete all saved data?")){
    results = [["Volunteer","Location","BIB","Date","Time"]];
    localStorage.removeItem("bibvoiceData");
    const table = document.getElementById("dataTable");
    table.innerHTML = "<tr><th>BIB Number</th><th>Time</th></tr>";
  }
}

// Restore saved data
window.onload = function(){
  const saved = localStorage.getItem("bibvoiceData");
  if(saved){
    results = JSON.parse(saved);
    const table = document.getElementById("dataTable");
    for(let i=results.length-1;i>=1;i--){
      const row = table.insertRow(1);
      row.insertCell(0).textContent = results[i][2];
      row.insertCell(1).textContent = results[i][4];
    }
  }
}
</script>

</body>
</html>
