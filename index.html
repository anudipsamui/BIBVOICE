<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SPORTROLIC TECH BIBVOICE</title>
<style>
body { font-family: sans-serif; padding: 20px; }
input[type="text"], input[type="tel"] { font-size: 1.2em; padding: 5px; margin-bottom: 5px; width: 200px; }
button { font-size: 1em; margin: 5px; padding: 5px 10px; }
table { border-collapse: collapse; margin-top: 15px; width: 100%; max-height: 300px; display: block; overflow-y: auto; }
table, th, td { border: 1px solid #ccc; }
th, td { padding: 8px; text-align: left; }
.highlight { background-color: #ffff99; }
#status { font-weight: bold; margin-bottom: 10px; }
.listening { color: green; }
.stopped { color: red; }
</style>
</head>
<body>

<h2>SPORTROLIC TECH BIBVOICE</h2>

Device Name: <input id="deviceInput" type="text" placeholder="Enter device name" /><br>
WhatsApp Number (with country code): <input id="waNumberInput" type="tel" placeholder="e.g., 919876543210" /><br><br>

<div id="status" class="stopped">‚èπ Not Listening</div>

<button onclick="startListening()">üé§ Start Listening</button>
<button onclick="stopListening()">‚èπ Stop Listening</button>
<button onclick="downloadCSV()">‚¨áÔ∏è Export CSV</button>
<button onclick="sendWhatsAppCSV()">üì§ Send CSV to WhatsApp</button><br><br>

Type Number: <input id="numberInput" type="text" placeholder="Enter number" />

<table id="dataTable">
  <tr><th>Device</th><th>Number</th><th>Time</th></tr>
</table>

<script>
let recognition;
let listening = false;
let results = [["Device","Number","Time"]];

// 24-hour timestamp
function getCurrentTimestamp() {
  const now = new Date();
  const h = String(now.getHours()).padStart(2,'0');
  const m = String(now.getMinutes()).padStart(2,'0');
  const s = String(now.getSeconds()).padStart(2,'0');
  return `${h}:${m}:${s}`;
}

// Add a row to table (latest on top)
function addRow(device, number) {
  const time = getCurrentTimestamp();
  results.push([device, number, time]);

  const table = document.getElementById("dataTable");
  const row = table.insertRow(1); // insert at top
  row.insertCell(0).textContent = device;
  row.insertCell(1).textContent = number;
  row.insertCell(2).textContent = time;

  // highlight latest row
  for(let i=1; i<table.rows.length; i++) table.rows[i].classList.remove("highlight");
  row.classList.add("highlight");

  table.scrollTop = 0; // keep top visible
}

// Natural number speech recognition
function spokenToDigits(spoken) {
  spoken = spoken.toLowerCase().trim();
  spoken = spoken.replace(/triple zero/g,'000').replace(/double zero/g,'00');

  const numbers = {
    "zero":0,"oh":0,"o":0,
    "one":1,"two":2,"three":3,"four":4,"five":5,
    "six":6,"seven":7,"eight":8,"nine":9,
    "ten":10,"eleven":11,"twelve":12,"thirteen":13,
    "fourteen":14,"fifteen":15,"sixteen":16,"seventeen":17,
    "eighteen":18,"nineteen":19,"twenty":20,"thirty":30,
    "forty":40,"fifty":50,"sixty":60,"seventy":70,
    "eighty":80,"ninety":90,"hundred":100
  };

  const words = spoken.split(/\s+/);
  let result = 0;
  let temp = 0;

  for(let w of words) {
    if(numbers.hasOwnProperty(w)) {
      let num = numbers[w];
      if(num === 100) {
        temp *= 100;
      } else if(num < 10) {
        temp = temp*10 + num;
      } else if(num >= 10 && num < 100) {
        temp += num;
      } else {
        temp += num;
      }
    }
  }
  result += temp;
  return result.toString();
}

// Start continuous speech recognition
function startListening() {
  const device = document.getElementById("deviceInput").value.trim();
  if(!device) return alert("Enter device name first");

  if(!('webkitSpeechRecognition' in window)){
    alert("Speech recognition not supported. Use Chrome.");
    return;
  }

  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = true;
  recognition.interimResults = false;

  recognition.onresult = function(event) {
    for(let i=event.resultIndex; i<event.results.length; i++){
      if(event.results[i].isFinal){
        let spoken = event.results[i][0].transcript.trim();
        let digits = spokenToDigits(spoken);
        if(digits.length>0) addRow(device,digits);
      }
    }
  }

  recognition.onerror = function(e){ console.error("Speech recognition error:", e); }

  recognition.onend = function(){ if(listening) recognition.start(); }

  recognition.start();
  listening = true;
  const statusDiv = document.getElementById("status");
  statusDiv.textContent = "üé§ Listening...";
  statusDiv.classList.remove("stopped");
  statusDiv.classList.add("listening");
}

// Stop listening
function stopListening() {
  if(recognition && listening){
    recognition.stop();
    listening=false;
    const statusDiv = document.getElementById("status");
    statusDiv.textContent = "‚èπ Not Listening";
    statusDiv.classList.remove("listening");
    statusDiv.classList.add("stopped");
  }
}

// Auto-save typed numbers
const numberInput = document.getElementById("numberInput");
numberInput.addEventListener("keypress",function(e){
  if(e.key==="Enter"){
    const device = document.getElementById("deviceInput").value.trim();
    const value = numberInput.value.trim();
    if(!device) return alert("Enter device name first");
    if(/^\d+$/.test(value)){
      addRow(device,value);
      numberInput.value="";
    } else { alert("Please enter digits only."); }
  }
});

// Export CSV with device name + date
function downloadCSV(){
  const device = document.getElementById("deviceInput").value.trim() || "Device";
  const now = new Date();
  const dateStr = now.toISOString().slice(0,10);
  const filename = `${device.replace(/\s+/g,'_')}_${dateStr}.csv`;
  let csvContent = results.map(r => r.join(",")).join("\n");
  const blob = new Blob([csvContent],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=filename; a.click();
  URL.revokeObjectURL(url);
}

// Send CSV to WhatsApp
function sendWhatsAppCSV(){
  const waNumber = document.getElementById("waNumberInput").value.trim();
  if(!waNumber) return alert("Enter WhatsApp number with country code");
  if(results.length<=1) return alert("No numbers logged yet");

  let csvText = results.map(r => r.join(",")).join("\n");
  csvText = encodeURIComponent(csvText);
  const url = `https://wa.me/${waNumber}?text=${csvText}`;
  window.open(url,'_blank');
}
</script>

</body>
</html>
